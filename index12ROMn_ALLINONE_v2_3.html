<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Hand ROM Analyzer – FINAL ALL IN ONE</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body{background:#111;color:#eee;font-family:system-ui;margin:0;padding:16px;}
h1{font-size:18px;margin-bottom:8px;}
#hud{position:fixed;top:8px;left:8px;font-size:11px;color:#9f9;max-width:90vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
#build{position:fixed;top:26px;left:8px;font-size:10px;color:#6f6;max-width:90vw;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
#controls{margin-bottom:12px;}
button{padding:10px;border-radius:8px;background:#333;color:#fff;border:none;margin:4px;}
button:hover{background:#555;}
#result{margin-top:12px;background:#1c1c1c;padding:10px;border-radius:8px;line-height:1.55;}
#joaPanel{display:none;background:#222;padding:10px;border-radius:8px;margin-top:10px;}
table{width:100%;border-collapse:collapse;font-size:12px;}
td,th{border:1px solid #555;padding:4px;text-align:center;}
small{color:#bbb;}
</style>
</head>

<body>

<h1>手指ROM解析（最終安定版・角度決定ロジック込み）</h1>

<div id="controls">
<b>指グループ</b><br>
<label><input type="radio" name="group" value="thumb" checked> 親指側（示・中）</label>
<label style="margin-left:8px;"><input type="radio" name="group" value="pinky"> 小指側（薬・小）</label>
<br><br>

<input type="file" id="videoInput" accept="video/*"><br><br>

<button onclick="startAnalyze('EXT_OK')">伸展可能</button>
<button onclick="startAnalyze('EXT_NG')">伸展不能</button>
<button onclick="toggleJOA()">JOA参考</button>
<button onclick="copyLog()">ログコピー</button>
</div>

<div id="result">動画を選択してください</div>

<div id="joaPanel">
<b>JOA 手指ROM（参考）</b>
<table>
<tr><th>指</th><th>MCP</th><th>PIP</th><th>DIP</th></tr>
<tr><td>示指</td><td>90</td><td>100</td><td>70</td></tr>
<tr><td>中指</td><td>90</td><td>100</td><td>70</td></tr>
<tr><td>薬指</td><td>90</td><td>100</td><td>70</td></tr>
<tr><td>小指</td><td>90</td><td>100</td><td>70</td></tr>
</table>
</div>

<div id="hud"></div>
<div id="build"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<script>
/* =========================
   VERSION / BUILD (必ずログ残す)
========================= */
const VERSION="12ROMn_ALLINONE_FINAL_v2.2_anglefix";
const BUILD=new Date().toISOString();
document.getElementById("build").innerText = VERSION + " / " + BUILD;

/* =========================
   LOG (失敗時フォールバック付き)
========================= */
let LOG=[];
function log(m){
  const t=new Date().toLocaleTimeString();
  const line=`[${t}] ${m}`;
  LOG.push(line);
  document.getElementById("hud").innerText=m;
}
function copyLog(){
  const text = LOG.join("\n");
  // まず clipboard
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(text).then(
      ()=>alert("ログをコピーしました"),
      ()=>fallbackCopy(text)
    );
  } else {
    fallbackCopy(text);
  }
}
function fallbackCopy(text){
  // 失敗しても必ずユーザーが取れる
  const ta = document.createElement("textarea");
  ta.value = text;
  ta.style.position="fixed";
  ta.style.left="8px";
  ta.style.top="60px";
  ta.style.width="92vw";
  ta.style.height="45vh";
  ta.style.zIndex="9999";
  document.body.appendChild(ta);
  ta.focus();
  ta.select();
  alert("クリップボードに失敗しました。表示したテキストを長押し/コピーしてください。");
}
function toggleJOA(){
  const p=document.getElementById("joaPanel");
  p.style.display = (p.style.display==="none") ? "block" : "none";
}

/* =========================
   Video / Canvas
========================= */
const video=document.createElement("video");
video.muted=true;
video.playsInline=true;
video.loop=true;

const canvas=document.createElement("canvas");
const ctx=canvas.getContext("2d");

/* =========================
   MediaPipe Hands
========================= */
const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
});
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.5,
  minTrackingConfidence:0.5
});

/* =========================
   Landmark storage
   - 取りすぎると重いので上限を決める
========================= */
let landmarksAll=[];
const MAX_FRAMES = 120; // 約4秒(30fps想定)分くらい
hands.onResults(res=>{
  if(res.multiHandLandmarks && res.multiHandLandmarks[0]){
    landmarksAll.push(res.multiHandLandmarks[0]);
    if(landmarksAll.length > MAX_FRAMES) landmarksAll.shift();
  }
});

/* =========================
   Frame loop
========================= */
let running=false;
async function startLoop(){
  if(running) return;
  running=true;
  log("frame loop started");
  while(running){
    if(video.readyState>=2){
      canvas.width=video.videoWidth||640;
      canvas.height=video.videoHeight||480;
      ctx.drawImage(video,0,0,canvas.width,canvas.height);
      try{
        await hands.send({image:canvas});
      }catch(e){
        log("hands.send failed");
      }
    }
    await new Promise(r=>setTimeout(r,33));
  }
}

/* =========================
   Analyze start (setTimeout撤廃)
   - framesが溜まるまで待つ
========================= */
let analyzing=false;

function startAnalyze(mode){
  const file=document.getElementById("videoInput").files[0];
  if(!file){log("no video");return;}
  if(analyzing){log("busy: analyzing");return;}

  analyzing=true;
  landmarksAll=[];

  video.src=URL.createObjectURL(file);

  video.onloadeddata=async()=>{
    try{
      await video.play();
    }catch(e){
      log("ERROR: video.play blocked");
      analyzing=false;
      return;
    }
    startLoop();
    waitForFramesThenAnalyze(mode);
  };
}

function waitForFramesThenAnalyze(mode){
  let tries=0;
  const need = 20; // 最低必要フレーム
  const timer=setInterval(()=>{
    tries++;
    const n=landmarksAll.length;
    if(n>=need){
      clearInterval(timer);
      log(`analyze start ${mode} (frames=${n})`);
      analyze(mode);
      analyzing=false;
    }else{
      log(`buffer waiting... ${n}`);
      if(tries>150){
        clearInterval(timer);
        log("ERROR: hand not detected (timeout)");
        analyzing=false;
      }
    }
  },200);
}

/* =========================
   Angle selection core (角度の決め方を変更)
   - 指ごとに「伸展フレーム」と「屈曲フレーム」を決める
   - ROM = flexFrame - extFrame
========================= */
function analyze(mode){
  const group=document.querySelector('input[name="group"]:checked').value;
  const fingers = group==="thumb"
    ? {index:[5,6,7,8], middle:[9,10,11,12]}
    : {ring:[13,14,15,16], pinky:[17,18,19,20]};

  if(landmarksAll.length < 5){
    log("frames不足");
    return;
  }

  let html = `<div><small>${VERSION} / ${BUILD}</small></div><hr style="border:0;border-top:1px solid #333;margin:8px 0;">`;

  for(const [name,ids] of Object.entries(fingers)){
    // 各フレームで角度を計算し、指の合計屈曲角でext/flexフレームを選ぶ
    let bestExt = null;   // {score, m, p, d}
    let bestFlex = null;  // {score, m, p, d}

    for(const lm of landmarksAll){
      const m = flex(lm[0], lm[ids[0]], lm[ids[1]]);        // MCP
      const p = flex(lm[ids[0]], lm[ids[1]], lm[ids[2]]);  // PIP
      const d = flex(lm[ids[1]], lm[ids[2]], lm[ids[3]]);  // DIP
      const score = m + p + d; // 合計屈曲角

      const pack = {score, m, p, d};
      if(!bestExt || score < bestExt.score) bestExt = pack;     // 最小=最伸展
      if(!bestFlex || score > bestFlex.score) bestFlex = pack;  // 最大=最屈曲
    }

    if(!bestExt || !bestFlex){
      html += `<b>${name}</b><br>解析失敗（フレーム不足）<br><br>`;
      continue;
    }

    // ROM（各関節）
    const mROM = clamp(bestFlex.m - bestExt.m, 0, 180);
    const pROM = clamp(bestFlex.p - bestExt.p, 0, 180);
    const dROM = clamp(bestFlex.d - bestExt.d, 0, 180);

    const tam = mROM + pROM + dROM;

    html += `<b>${name}</b><br>`;
    // EXT_OKでもEXT/FLEX値を見える化（あなたのデバッグ要求）
    html += `伸展基準（最小）: MCP ${bestExt.m.toFixed(1)}° / PIP ${bestExt.p.toFixed(1)}° / DIP ${bestExt.d.toFixed(1)}°<br>`;
    html += `屈曲基準（最大）: MCP ${bestFlex.m.toFixed(1)}° / PIP ${bestFlex.p.toFixed(1)}° / DIP ${bestFlex.d.toFixed(1)}°<br>`;
    html += `<b>ROM</b>: MCP ${mROM.toFixed(1)}° / PIP ${pROM.toFixed(1)}° / DIP ${dROM.toFixed(1)}°<br>`;

    // 伸展不能モードはTAMを「参考として」併記（欲張らない方針に従い、ROM主）
    if(mode==="EXT_NG"){
      html += `総運動角（TAM, 参考）：${tam.toFixed(1)}°<br>`;
    }
    html += `<br>`;
  }

  document.getElementById("result").innerHTML = html;
  log("analysis finished");
}

/* =========================
   Geometry
   - MediaPipeの外角(直線=180)を屈曲角に変換
========================= */
function flex(a,b,c){
  return clamp(180 - raw(a,b,c), 0, 180);
}
function raw(a,b,c){
  const v1={x:a.x-b.x,y:a.y-b.y,z:a.z-b.z};
  const v2={x:c.x-b.x,y:c.y-b.y,z:c.z-b.z};
  const dot=v1.x*v2.x+v1.y*v2.y+v1.z*v2.z;
  const m=Math.hypot(v1.x,v1.y,v1.z)*Math.hypot(v2.x,v2.y,v2.z);
  if(!m) return 0;
  const cos = clamp(dot/m, -1, 1);
  return Math.acos(cos)*180/Math.PI;
}
function clamp(v,min,max){ return Math.min(max, Math.max(min, v)); }

/* =========================
   Boot log (キャッシュ識別に必須)
========================= */
log("index initialized");
log(`VERSION=${VERSION}`);
log(`BUILD=${BUILD}`);
log(`UA=${navigator.userAgent}`);
</script>

</body>
</html>
