<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>Hand ROM Analyzer – ALL IN ONE (12ROMn)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<style>
body{background:#111;color:#eee;font-family:system-ui;margin:0;padding:16px;}
h1{font-size:18px;margin-bottom:8px;}
#hud{position:fixed;top:8px;left:8px;font-size:11px;color:#9f9;}
#build{position:fixed;top:24px;left:8px;font-size:10px;color:#6f6;}
#controls{margin-bottom:12px;}
button{padding:10px;border-radius:8px;background:#333;color:#fff;border:none;margin:4px;}
button:hover{background:#555;}
#result{margin-top:12px;background:#1c1c1c;padding:10px;border-radius:8px;}
#joaPanel{display:none;background:#222;padding:10px;border-radius:8px;margin-top:10px;}
table{width:100%;border-collapse:collapse;font-size:12px;}
td,th{border:1px solid #555;padding:4px;text-align:center;}
</style>
</head>

<body>

<h1>手指ROM解析（動画・全部入り安定版）</h1>

<div id="controls">
<b>指グループ</b><br>
<label><input type="radio" name="group" value="thumb" checked> 親指側（示・中）</label>
<label style="margin-left:8px;"><input type="radio" name="group" value="pinky"> 小指側（薬・小）</label>
<br><br>

<input type="file" id="videoInput" accept="video/*"><br><br>

<button onclick="startAnalyze('EXT_OK')">伸展可能</button>
<button onclick="startAnalyze('EXT_NG')">伸展不能</button>
<button onclick="toggleJOA()">JOA参考</button>
<button onclick="copyLog()">ログコピー</button>
</div>

<div id="result">動画を選択してください</div>

<div id="joaPanel">
<b>JOA 手指ROM（参考）</b>
<table>
<tr><th>指</th><th>MCP</th><th>PIP</th><th>DIP</th></tr>
<tr><td>示指</td><td>90</td><td>100</td><td>70</td></tr>
<tr><td>中指</td><td>90</td><td>100</td><td>70</td></tr>
<tr><td>薬指</td><td>90</td><td>100</td><td>70</td></tr>
<tr><td>小指</td><td>90</td><td>100</td><td>70</td></tr>
</table>
</div>

<div id="hud"></div>
<div id="build"></div>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>

<script>
/* =====================================================
   Hand ROM Analyzer – ROM FIXED
   ALL-IN-ONE ANALYZE CORE
   ===================================================== */

const ANALYZE_VERSION = "ROM_FIXED_v2.0";
log("Analyze core loaded : " + ANALYZE_VERSION);

/* ===== Analyze Entry ===== */
function analyze(mode){
  log(`analyze start ${mode}`);

  if(buffer.length < 10){
    log("frames不足");
    return;
  }

  const group = document.querySelector('input[name="group"]:checked').value;

  const fingers = (group === "thumb")
    ? { index:[5,6,7,8], middle:[9,10,11,12] }
    : { ring:[13,14,15,16], pinky:[17,18,19,20] };

  let html = "";

  for(const [name, ids] of Object.entries(fingers)){

    let MCP = [], PIP = [], DIP = [];

    for(const lm of buffer){
      MCP.push(flex(lm[0], lm[ids[0]], lm[ids[1]]));
      PIP.push(flex(lm[ids[0]], lm[ids[1]], lm[ids[2]]));
      DIP.push(flex(lm[ids[1]], lm[ids[2]], lm[ids[3]]));
    }

    const mMin = Math.min(...MCP), mMax = Math.max(...MCP);
    const pMin = Math.min(...PIP), pMax = Math.max(...PIP);
    const dMin = Math.min(...DIP), dMax = Math.max(...DIP);

    const mROM = mMax - mMin;
    const pROM = pMax - pMin;
    const dROM = dMax - dMin;

    html += `<b>${name}</b><br>`;

    html += `
      MCP：伸展 ${mMin.toFixed(1)}° / 屈曲 ${mMax.toFixed(1)}°
      （ROM ${mROM.toFixed(1)}°）<br>
      PIP：伸展 ${pMin.toFixed(1)}° / 屈曲 ${pMax.toFixed(1)}°
      （ROM ${pROM.toFixed(1)}°）<br>
      DIP：伸展 ${dMin.toFixed(1)}° / 屈曲 ${dMax.toFixed(1)}°
      （ROM ${dROM.toFixed(1)}°）<br>
    `;

    if(mode === "EXT_NG"){
      const TAM = mROM + pROM + dROM;
      html += `総運動角（TAM）：${TAM.toFixed(1)}°<br>`;
    }

    html += `<br>`;
  }

  document.getElementById("result").innerHTML = html;
  log("analysis finished");
}

/* ===== Geometry ===== */
function flex(a,b,c){
  return Math.max(0, 180 - raw(a,b,c));
}

function raw(a,b,c){
  const v1={x:a.x-b.x,y:a.y-b.y,z:a.z-b.z};
  const v2={x:c.x-b.x,y:c.y-b.y,z:c.z-b.z};
  const dot=v1.x*v2.x+v1.y*v2.y+v1.z*v2.z;
  const mag=Math.hypot(v1.x,v1.y,v1.z)*Math.hypot(v2.x,v2.y,v2.z);
  if(!mag) return 0;
  return Math.acos(Math.min(1,Math.max(-1,dot/mag))) * 180/Math.PI;
}
</script>
  

</body>
</html>
